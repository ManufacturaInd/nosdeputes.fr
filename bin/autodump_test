#!/bin/bash
source bin/db.inc

for year in 08 09 ; do
  for month in 01 02 03 04 05 06 07 08 09 10 11 12 ; do
    for day in 01 02 03 04 05 06 07 08 09 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 ; do
      if [[ ($day = "31" && ($month = "02" || $month = "04" || $month = "06" || $month = "09" || $month = "11")) || ($month = "02" && (($day = "29" && $year = "09") || $day = "30")) ]]; then
       continue 
      fi
      echo $(date -d$year$month$day)

echo "mysqldump $MYSQLID $DBNAME -q --single-transaction --add-drop-table -R -t --disable-keys --complete-insert" | gzip > data/sql/dumps/nosdeputes.$(date -d$year$month$day +%y%m%d).sql.gz

# On archive tous les 1er du mois et tous les dimanches
if [[ $(date -d$year$month$day +%-w) -eq 0 || $(date -d$year$month$day +%-d) -eq 1 ]]; then
  cp data/sql/dumps/nosdeputes.$(date -d$year$month$day +%y%m%d).sql.gz data/sql/dumps/archives/
fi

# On efface tous les mois les archives hebdomadaires vieilles de plus d'un mois mais on garde l'archive mensuelle
if [[ $(date -d$year$month$day +%-d) -eq 1 ]]; then
  if [[ $(date -d$year$month$day +%-m) -le 2 ]]; then
    year0=`expr $(date -d$year$month$day +%y) - 1`
    month0=`expr $(date -d$year$month$day +%m) + 10`
  else
    year0=`expr $(date -d$year$month$day +%y) + 0`
    month0=`expr $(date -d$year$month$day +%m) - 2`
  fi
  ym=`printf "%02d%02d" $year0 $month0`
  rm -f `ls data/sql/dumps/archives/nosdeputes.${ym}*.sql.gz | grep -v nosdeputes.${ym}01.sql.gz`
fi

# On efface les dumps vieux de plus d'une semaine
if [[ $(date -d$year$month$day +%-d) -le 7 ]]; then
  day0=`expr $(date -d$year$month$day +%d) + 21`
else
  day0=`expr $(date -d$year$month$day +%d) - 7`
fi
rm -f data/sql/dumps/nosdeputes.*`printf "%02d" $day0`.sql.gz
if [[ $(date -d$year$month$day +%-d) -eq 8 ]]; then
  rm -f data/sql/dumps/nosdeputes.*29.sql.gz
  rm -f data/sql/dumps/nosdeputes.*30.sql.gz
  rm -f data/sql/dumps/nosdeputes.*31.sql.gz
fi
    # if [[ $day = "01" || $day = "06" || $day = "07" ||  $day = "08" || $day = "10" || $day = "30" || $day = "31" ]]; then
      # read -p "press to continue..."
    # fi
    done
    # read -p "press to continue..."
  done
done

