<?php

/**
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class Amendement extends BaseAmendement {

  public function setAuteurs($auteurs) {
    $groupe = null;
    $sexe = null;
    if (preg_match('/^\s*(.*),+\s*les\s+(.*\s+[gG]roupe|membres)\s+(.*)\s*$/' ,$auteurs, $match)) {
      $auteurs = $match[1];
      $groupe = preg_replace("/^\s*(de la|de l'|du)\s*/", "", $match[3]);
      if (preg_match('/(union.*mouvement.*populaire|UMP)/i',$groupe)) $groupe = "UMP";
      elseif (preg_match('/(socialiste.*radical|SRC)/i',$groupe)) $groupe = "SRC";
	  elseif (preg_match('/(gauche.*démocrate|GDR)/i',$groupe)) $groupe = "GDR";
      elseif (preg_match('/(nouveau.*centre|NC)/i',$groupe)) $groupe = "NC";
      else $groupe = null;
    }
    $arr = preg_split('/,/', $auteurs);
    foreach ($arr as $depute) {
      if (preg_match('/(gouvernement|président|rapporteur|commission|questeur)/i', $depute)) {
        if ($debug) print "WARN: Skip auteur ".$depute." for ".$this->source."\n";
        continue;
      } elseif (preg_match('/^\s*(M+[\s\.ml]{1})[a-z]*\s*([dA-Z].*)\s*$/', $depute, $match)) {
          $nom = $match[2];
          if (preg_match('/M[ml]/', $match[1]))
            $sexe = 'F';
          else $sexe = 'H';
      } else $nom = preg_replace("/^\s*(.*)\s*$/", "\1", $depute);
      $depute = Doctrine::getTable('Parlementaire')->findOneByNomSexeGroupe($nom, $sexe, $groupe, $this);
      if (!$depute) print "ERROR: Auteur introuvable in ".$this->source." : ".$nom." // ".$sexe." // ".$groupe."\n";
      else {
        if (!$groupe) $groupe = $depute->getGroupe()->getNom();
        $this->addParlementaire($depute);
        $depute->free();
      }
    }
  }

  public function addParlementaire($depute) {
    foreach($this->getParlementaires() as $par)
      if ($par == $depute) {
        $par->free();
        return true;
      }
    $pa = new ParlementaireAmendement();
    $pa->_set('Parlementaire', $depute);
    $pa->_set('Amendement', $this);
    if ($pa->save()) {
      $pa->free();
      return true;
    } else return false;
  }

  public function getSignataires() {
    return preg_replace("/M\s+/", "M. ", $this->_get('signataires'));
  }

  public function getTitre() {
    $parent = 0;
    $pluriel = "";
    $parent = $this->getTags(array('is_triple' => true,
	  'namespace' => 'loi',
	  'key' => 'sous_amendement_de',
	  'return'    => 'value'));
    if (count($parent) == 1)
      $titre = "Sous-Amendement";
    else {
      $parent = "";
      $titre = "Amendement";
    }
    $numeros = $this->numero;
    $ident = $this->getTags(array('is_triple' => true,
	  'namespace' => 'loi',
	  'key' => 'amendement',
	  'return'    => 'value'));
    if (count($ident) > 1) {
      sort($ident);
      $numeros = implode(', ', $ident);
      $pluriel = "s";
    }
    $titre .= $pluriel." N° ".$numeros;
    if ($this->rectif == 1)
      $titre .= " rectifié".$pluriel;
    elseif($this->rectif > 1)
      $titre .= " ".$this->rectif."ème rectif.";
    if ($parent != 0)
      $titre .= " à l'amendement N° ".link_to($parent[0], '@find_amendements_by_loi_and_numero?loi='.$this->texteloi_id.'&numero='.$parent[0]);
    return "$titre";
  }

  public function getTexte() {
    return preg_replace('/\<p\>\s*«\s*([^»]+)\s+»(\W*)\<\/p\>/', '<p class="indent_guillemets">«&nbsp;\1&nbsp;»\2</p>', $this->_get('texte'));
  }

public function getTitreNoLink() {
    return preg_replace('/\<a href.*\<\/a\>/', '', $this->getTitre());
  }

  public function getLinkPDF() {
    return preg_replace('/\/amendement/', '/pdf/amendement', preg_replace('/\.asp(.*)$/', '\.pdf', $this->source));
  }
}