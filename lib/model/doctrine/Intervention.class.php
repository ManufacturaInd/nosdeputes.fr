<?php

/**
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class Intervention extends BaseIntervention
{
  public function setSeance($type, $date, $heure, $session, $commission = null) {
    $this->setType($type);
    if ($type == 'commission') {
      $commission = Doctrine::getTable('Organisme')->findOneByNomOrCreateIt($commission, 'parlementaire');
      $seance = $commission->getSeanceByDateAndMomentOrCreateIt($date, $heure, $session);
      $commission->free();
    } else{
      $seance = Doctrine::getTable('Seance')->findOneOrCreateIt('hemicycle', $date, $heure, $session);
    }
    $id = $this->_set('seance_id', $seance->id);
    $seance->free();
    return $id;
  }
  public function setPersonnaliteByNom($nom, $fonction = null) 
  {
    $this->setFonction($fonction);
    if (!preg_match('/ministre|secr[^t]+taire [^t]+tat|commissaire|garde des sceaux/i', $fonction)) { 
      $personne = Doctrine::getTable('Parlementaire')->findOneByNom($nom);
      if (!$personne) {
	$personne = Doctrine::getTable('Parlementaire')->similarTo($nom);
      }
      if ($personne) {
	return $this->setParlementaire($personne);
      }
    }
    $personne = Doctrine::getTable('Personnalite')->findOneByNom($nom);
    if (!$personne) {
      $personne = Doctrine::getTable('Personnalite')->similarTo($nom);
    }
    if (!$personne) {
      $personne = new Personnalite();
      $personne->setNom($nom);
      $personne->save();
    }
    if ($personne) {
      return $this->setPersonnalite($personne,$fonction);
    }
  }
  public function setParlementaire($parlementaire, $from_db = null) {
    if (isset($parlementaire->id)) {
      $this->_set('parlementaire_id', $parlementaire->id);
      if (!$from_db)
        $this->getSeance()->addPresence($parlementaire, 'intervention', $this->source);
    }
    $parlementaire->free();
  }

  public function hasIntervenant() {
    if ($this->parlementaire_id) {
      return true;
    }
    if ($this->personnalite_id) {
      return true;
    }
    return false;
  }

  public function getIntervenant() {
    $perso = $this->Parlementaire;
    if (!$perso->id)
      $perso = $this->Personnalite;
    return $perso;
  }

  public function getNomAndFonction() {
    $res = null;
    if ($this->hasIntervenant()) {
      $res = $this->getIntervenant()->getNom();
      if ($this->getFonction())
	$res .= ', '.$this->getFonction();
    }
    return $res;
  }

  public function setContexte($context, $date = null, $timestamp = null) {
    return $this->setSection(doctrine::getTable('Section')->findOneByContexteOrCreateIt($context, $date, $timestamp));
  }

  public function setAmendements($tamendements) {
    $tamendements = preg_replace('/[^,\d]+/', '', $tamendements);
    $amends = preg_split('/\s*,\s*/', $tamendements);
    foreach($amends as $amend) {
      $tag = 'loi:amendement='.$amend;
      $this->addTag($tag);
      if ($this->Section->section_id && $this->Section->Section->id) {
        $this->Section->Section->addTag($tag);
      }
    }
  }
  public function setLois($tlois) {
    $tlois = preg_replace('/[^,\d]+/', '', $tlois);
    $lois = preg_split('/\s*,\s*/', $tlois);
    foreach($lois as $loi) {
      $tag = 'loi:numero='.$loi;
      $this->addTag($tag);
      $this->Section->addTag($tag);
      if ($this->Section->section_id && $this->Section->Section->id) {
	$this->Section->Section->addTag($tag);
      }
    }
  }
  public function setIntervention($s) {
    $this->_set('nb_mots', str_word_count($s));
    return $this->_set('intervention', $s);
  }

  public function getIntervention($args = array()) {
    $inter = $this->_get('intervention');
    if (isset($args['linkify_amendements']) && $linko = $args['linkify_amendements']) {
      if (preg_match_all('/(amendements?[,\s]+(identiques?)?[,\s]*)((n[°os\s]*|\d+\s*|,\s*|à\s*|et\s*|rectifié\s*)+)/', $inter, $match)) {
	$lois = implode(',', $this->getTags(array('is_triple' => true,
						  'namespace' => 'loi',
						  'key' => 'numero',
						  'return'    => 'value')));
	for ($i = 0 ; $i < count($match[0]) ; $i++) {
	  if (preg_match_all('/\s*(\d[\d\s\à]*rectifiés?|\d[\d\s\à]*)(,\s*|\s*et\s*)*/', $match[3][$i], $amends)) {
	    $replace = $match[3][$i];
	    foreach($amends[1] as $amend) {
	      $amend = preg_replace('/à/', 'a', $amend);
	      $am = preg_replace('/[^\da]+/', '',$amend);
	      $link = str_replace('LLL', urlencode($lois), $linko);
	      $link = str_replace('AAA', urlencode($am), $link);
	      $replace = preg_replace('/'.$amend.'/', ' <a name="amend_'.$am.'" href="'.$link.'">'.$amend.'</a> ', $replace);
	    }
	    $inter = preg_replace('/'.$match[1][$i].$match[3][$i].'/', $match[1][$i].$replace, $inter);
	  }
	}
      }
    }
    return $inter;
  }
}