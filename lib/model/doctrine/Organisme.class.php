<?php

require_once "myTools.class.php";

/**
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class Organisme extends BaseOrganisme
{
  public function getSmallNomGroupe() {
    $hashmap = array(
        "union pour un mouvement populaire" => "UMP",
        "socialiste, radical, citoyen et divers gauche" => "SRC",
        "gauche démocrate et républicaine" => "GDR",
        "députés n'appartenant à aucun groupe" => "NI",
        "nouveau centre" => "NC"
    );
    return $hashmap[$this->getNom()];
  }

  public function getSeanceByDateAndMomentOrCreateIt($date, $moment) {
    $seance = $this->getSeanceByDateAndMoment($date, $moment);
    if (!$seance) {
      $seance = new Seance();
      $seance->type = 'commission';
      $seance->setDate($date);
      $seance->moment = Seance::convertMoment($moment);
      $seance->Organisme = $this;
      $seance->save();
    }
    return $seance;
  }


  public function getSeanceByDateAndMoment($date, $moment) {
    $moment = Seance::convertMoment($moment);
    $q = Doctrine::getTable('Seance')->createQuery('s');
    $q->where("organisme_id = ?", $this->id)->andWhere('date = ?', $date)->andWhere('moment = ?', $moment);
    $res = $q->fetchOne();
    $q->free();
    unset($q);
    if (!$res) {
      $q = Doctrine::getTable('Seance')->createQuery('s');
      $q->where("organisme_id = ?", $this->id)->andWhere('date = ?', $date);
      if (count($res = $q->fetchArray()) && preg_match('/(\d+)[:](\d+)/', $moment, $match)) {
	$match[2]+=15;
	if ($match[2] < 60) {
	  $q = Doctrine::getTable('Seance')->createQuery('s');
	  $q->where("organisme_id = ?", $this->id)->andWhere('date = ?', $date)->andWhere('moment = ?', $match[1].':'.$match[2]);
	  $res = $q->fetchOne();
	  $q->free();
	  unset($q);
	}
	if (!$res) {
	  $match[2]-=30;
	  if ($match[2] > 0) {
	    $q = Doctrine::getTable('Seance')->createQuery('s');
	    $q->where("organisme_id = ?", $this->id)->andWhere('date = ?', $date)->andWhere('moment = ?', $match[1].':'.$match[2]);
	    $res = $q->fetchOne();
	    $q->free();
	    unset($q);
	  }
	}
      }
    }
    return $res;
  }
}